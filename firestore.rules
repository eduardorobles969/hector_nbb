rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function hasCoachAssignment(userUid, coachUid) {
      return exists(
        /databases/$(database)/documents/assignments/$(userUid)/coaches/$(coachUid)
      );
    }

    function isCoachFor(uid) {
      return isSignedIn() && hasCoachAssignment(uid, request.auth.uid);
    }

    function isAssignedPair(uid) {
      return isSignedIn() && (
        hasCoachAssignment(uid, request.auth.uid) ||
        hasCoachAssignment(request.auth.uid, uid)
      );
    }

    function getUserDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    // Helpers de listas (evita lower/upper)
    function inList(v, list) {
      return list.hasAny([v]);
    }

    function roleVariants(role) {
      let coach = ['coach','Coach','COACH'];
      let admin = [
        'admin','Admin','ADMIN',
        'administrator','Administrator','ADMINISTRATOR'
      ];
      let coloso = [
        'coloso_prime','coloso-prime','colosoprime','colosoPrime','coloso prime',
        'Coloso_prime','Coloso-prime','ColosoPrime','Coloso Prime',
        'COLOSO_PRIME','COLOSO-PRIME','COLOSOPRIME'
      ];

      return inList(role, coach) ? coach
           : inList(role, coloso) ? coloso
           : inList(role, admin) ? admin
           : [role]; // sin normalizar: devuelve tal cual
    }

    function hasRole(userDoc, role) {
      return userDoc.data != null &&
        userDoc.data.role is string &&
        (
          roleVariants(role).hasAny([userDoc.data.role]) ||
          roleVariants(userDoc.data.role).hasAny([role])
        );
    }

    function isAdmin() {
      return isSignedIn() && hasRole(getUserDoc(request.auth.uid), 'admin');
    }

    function isCoachRole(userDoc) {
      return hasRole(userDoc, 'coach');
    }

    function isCoach() {
      return isSignedIn() && isCoachRole(getUserDoc(request.auth.uid));
    }

    function isValidThreadMembers(members) {
      return members is list &&
        members.size() == 2 &&
        members[0] is string &&
        members[1] is string &&
        members[0] != members[1];
    }

    function isChatPair(uidA, uidB) {
      return isAdmin() ||
        hasCoachAssignment(uidA, uidB) ||
        hasCoachAssignment(uidB, uidA);
    }

    function canCreateThread(data) {
      return isSignedIn() &&
        data.keys().hasAll(['members']) &&
        isValidThreadMembers(data.members) &&
        data.members.hasAny([request.auth.uid]) &&
        isChatPair(data.members[0], data.members[1]);
    }

    function memberListContains(data, uid) {
      return data.members is list && data.members.hasAny([uid]);
    }

    function isThreadMember(threadId) {
      let thread = get(/databases/$(database)/documents/coach_threads/$(threadId));
      return isSignedIn() &&
        thread.data != null &&
        memberListContains(thread.data, request.auth.uid);
    }

    function noDietFields(data) {
      return !(data.keys().hasAny(['weight','calories','caloria','bmi','imc']));
    }

    // ---------- MATCHES ----------
    match /users/{uid} {
      allow read: if isOwner(uid) || isAssignedPair(uid) || isAdmin();
      allow write: if (isOwner(uid) || isAdmin()) &&
        noDietFields(request.resource.data);
    }

    match /profiles/{uid} {
      allow read: if isOwner(uid) || isAssignedPair(uid) || isAdmin();
      allow write: if isOwner(uid) && noDietFields(request.resource.data);
    }

    match /onboarding_answers/{uid} {
      allow read, write: if isOwner(uid) || isCoachFor(uid) || isAdmin();
    }

    match /plans/{uid} {
      allow read: if isOwner(uid) || isCoachFor(uid) || isAdmin();
      allow write: if isOwner(uid) || isAdmin();
    }

    match /adaptive_plans/{uid} {
      allow read: if isOwner(uid) || isCoachFor(uid) || isAdmin();
      allow write: if (isOwner(uid) || isCoachFor(uid) || isAdmin()) &&
        noDietFields(request.resource.data);
    }

    match /journal/{uid}/entries/{entryId} {
      allow read: if isOwner(uid) || isCoachFor(uid) || isAdmin();
      allow write: if isOwner(uid) && noDietFields(request.resource.data);
    }

    match /activities/{uid}/logs/{logId} {
      allow read: if isOwner(uid) || isCoachFor(uid) || isAdmin();
      allow write: if isOwner(uid);
    }

    match /coach_threads/{threadId} {
      allow get: if isSignedIn() && memberListContains(resource.data, request.auth.uid);
      allow list: if false;
      allow create: if canCreateThread(request.resource.data);
      allow update: if isSignedIn() &&
        (
          (memberListContains(resource.data, request.auth.uid) &&
            request.resource.data.members == resource.data.members) ||
          canCreateThread(request.resource.data)
        );
      allow delete: if false;

      match /messages/{messageId} {
        allow get, list: if isThreadMember(threadId);
        allow create: if isThreadMember(threadId) &&
          request.resource.data.fromUid == request.auth.uid;
        allow update: if false;
        allow delete: if false;
      }
    }

    // Nombre de subcolección explícito para mantener colección/documento/colección/documento
    match /ai_insights/{uid}/insights/{insightId} {
      allow read: if isOwner(uid) || isCoachFor(uid) || isAdmin();
      allow write: if isCoachFor(uid) || isAdmin();
    }

    match /community/posts/{postId} {
      allow read: if true;
      allow create: if isSignedIn() && noDietFields(request.resource.data);
      allow update, delete: if isSignedIn() &&
        (isAdmin() || request.auth.uid == resource.data.authorUid) &&
        noDietFields(request.resource.data);
    }

    match /community/posts/{postId}/comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn() && noDietFields(request.resource.data);
      allow update, delete: if isSignedIn() &&
        (isAdmin() || request.auth.uid == resource.data.authorUid) &&
        noDietFields(request.resource.data);
    }

    match /lessons/{lessonId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /challenges/{challengeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /achievements/{uid}/{achievementId} {
      allow read, write: if isOwner(uid) || isCoachFor(uid) || isAdmin();
    }

    match /assignments/{uid}/coaches/{coachUid} {
      allow read: if isOwner(uid) || request.auth.uid == coachUid || isAdmin();
      allow write: if isAdmin();
    }

    match /prime_leads/{leadId} {
      allow create: if isSignedIn() &&
        request.auth.uid == leadId &&
        (!request.resource.data.keys().hasAny(['uid']) ||
          request.resource.data.uid == request.auth.uid);

      allow update: if (
        (isOwner(leadId) &&
          (!request.resource.data.keys().hasAny(['uid']) ||
            request.resource.data.uid == leadId)) ||
        (isCoach() &&
          (!request.resource.data.keys().hasAny(['uid']) ||
            request.resource.data.uid == leadId)) ||
        isAdmin()
      );

      allow get: if isOwner(leadId) || isCoach() || isAdmin();
      allow list: if isCoach() || isAdmin();
      allow delete: if isAdmin();
    }
  }
}
